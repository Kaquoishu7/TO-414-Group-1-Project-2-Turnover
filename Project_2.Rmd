---
title: "Project_2"
author: "Aakash Bharat, Ishan Goel, Doyeon Kim, Raamiz Qureshi, Maegan DeSmet"
date: "2022-10-27"
output:
  html_document:
    toc: true
    theme: united
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Employee Turnover

### Summary

We have selected a data set that discusses the simulated employee turnover of company called TECHCO. This data set is both interesting and pertinent to a manager at TECHCO.

#### Why it's Interesting

Firstly, the data set has a lot of data points (over 34,000), so any model we create can be substantially trained. Secondly, the data set has 10 different variables that seem reasonable to consider for employee turnover. For example, knowing the gender, the distance from work, and at least one test score seems like interesting factors to consider. Lastly, the data set is available on Kaggle, so we'll have a way to test our final model in addition to the data we set aside for testing only in our RMD file.

#### Why it's a Business Problem

Employee turnover is an important factor in businesses. Hiring and training new employees in an investment, so if employee turnover is high, that investment begins to turn into a net loss. Retaining employees will allow firms to minimize hiring/training expenses and profit more from their employees' work. Furthermore, the more experience an employee has at the firm, the more valuably they'd be able to contribute; they have expertise and wisdom about working at the firm that new employees will not.

### Logistic Model

```{r}
turnover = read.csv("simulated_TECHCO_data.csv")
str(turnover)
summary(turnover)
```

```{r}
turnover$turnover = ifelse(turnover$turnover == "Stayed", 0, 1)
turnover$gender = turnover$is_male
turnover$gender = ifelse(turnover$gender == 1, "Male", "Female")
turnover$is_male = NULL
turnover$emp_id = NULL
```

```{r}
logModelInitial =
  glm(formula = turnover ~ . + gender * similar_language,
               data = turnover,
               family = "binomial")
logModelInitial =
  step(logModelInitial, direction = "backward", trace = 0)
summary(logModelInitial)
```
# Layer 1 For Stack Model

## Libraries

```{r}
library(neuralnet)
library(class)
library(caret)
library(gmodels)
library(kernlab)
library(C50)
```

## Setup

```{r}
set.seed(0)
testIndices1 = sample(nrow(turnover), round(nrow(turnover) / 2))

# Use for L, SVM, and DT
trainReg1 = turnover[-testIndices1,]
testReg1 = turnover[testIndices1,]

trainRegUS1 = trainReg1
trainRegUS1$turnover = as.factor(trainRegUS1$turnover)

trainRegUS1 = upSample(trainRegUS1, trainRegUS1$turnover)
trainRegUS1$turnover = ifelse(trainRegUS1$turnover == "0", 0 , 1)
trainRegUS1$Class = NULL

testRegLabels1 = turnover[testIndices1,"turnover"]

# Train model variables that are shared

control <- trainControl(method = "cv", number = 10,
                           selectionFunction = "oneSE")

```

```{r}
turnoverUS = turnover
turnoverUS$turnover = as.factor(turnoverUS$turnover)

turnoverUS = upSample(turnoverUS, turnoverUS$turnover)
turnoverUS$turnover = ifelse(turnoverUS$turnover == "0", 0 , 1)
turnoverUS$Class = NULL

turnoverTestLabels = turnover$turnover

```


## Logistic

```{r, cache = TRUE}
set.seed(300)
logModel1 <- train(as.factor(turnover) ~ . + gender * .,
                        method = "glm",
                        data = turnoverUS,
                        trControl = control,
                        family = "binomial")
logModel1
logPredictions1 <- predict(logModel1, newdata = turnover, type = "prob")
summary(logPredictions1$`1`)

pred2 <- ifelse(logPredictions1$`1` >= 0.6, 1, 0)
table(pred2)

```
```{r}

CrossTable(logPredictions1,
           turnoverTestLabels,
           prop.chisq = FALSE, prop.c = FALSE,
           prop.r = FALSE,
           dnn = c('Predicted Turnover', 'Actual Turnover'))
confusionMatrix(as.factor(logPredictions1),
                as.factor(turnoverTestLabels))

confusionMatrix(as.factor(pred2),
                as.factor(turnoverTestLabels), positive = "1")

length(pred2)
nrow(turnover)
```



## KNN
```{r, cache = TRUE}
library(class)
library(caret)
library(ggplot2)

set.seed(300)
grid <- expand.grid(.k = c(5, 15, 25, 99, 131))

KNNModel <- train(as.factor(turnover) ~ .,
                        method = "knn",
                        metric = "Kappa",
                        data = turnoverUS,
                        preProcess = c("center", "scale"),
                        trControl = control,
                        tuneGrid = grid)
KNNModel
```

```{r}
KNNPred <- predict(KNNModel, turnover)
table(KNNPred, turnoverTestLabels)

confusionMatrix(as.factor(KNNPred),
                as.factor(turnoverTestLabels))

CrossTable(KNNPred, turnoverTestLabels,
           prop.chisq = FALSE, prop.c = FALSE,
           prop.r = FALSE,
           dnn = c('Predicted Turnover', 'Actual Turnover'))
```

## ANN

```{r, cache = TRUE}

set.seed(300)
grid <- expand.grid(.size = c(3, 4, 3), .decay = 0)

ANNModel1 <- train(as.factor(turnover) ~ .,
                   method = "nnet",
                   metric = "Kappa",
                   data = turnoverUS,
                   trControl = control,
                   tuneGrid = grid,
                   preProcess = c("center", "scale"))
ANNModel1
ANNPred <- predict(ANNModel1, turnover)

```

```{r}
CrossTable(ANNPred, turnoverTestLabels,
           prop.chisq = FALSE, prop.c = FALSE,
           prop.r = FALSE,
           dnn = c('Predicted Turnover', 'Actual Turnover'))
confusionMatrix(as.factor(ANNPred), as.factor(turnoverTestLabels))
```

## SVM

```{r, cache = TRUE}
set.seed(300)

grid <- expand.grid(sigma = c(0.3, 0.5, 0.7, 0.9),
                    C = c(3, 5, 10, 15))

svm_model <- train(as.factor(turnover) ~.,
                  data = turnoverUS, method = "svmRadial",
                  tuneGrid = grid, 
                  trControl= control) 

svm_model

```

```{r}
SVMPred <- predict(svm_model, turnover)

table(SVMPred, turnoverTestLabels)

confusionMatrix(as.factor(SVMPred),
                as.factor(turnoverTestLabels))

CrossTable(SVMPred, turnoverTestLabels,
           prop.chisq = FALSE, prop.c = FALSE,
           prop.r = FALSE,
           dnn = c('Predicted Turnover', 'Actual Turnover'))
```


## DT

```{r, cache = TRUE}
set.seed(300)

grid <- expand.grid(.model = "tree",
                    .trials = c(1, 5, 10, 15, 20),
                    .winnow = "FALSE")

dt_model <- train(as.factor(turnover) ~.,
                  data = turnoverUS, method = "C5.0",
                  tuneGrid = grid, metric = "Kappa",
                  trControl= control)
dt_predict <- predict(dt_model, turnover)


```
```{r}

CrossTable(dt_predict, turnoverTestLabels,
           prop.chisq = FALSE, prop.c = FALSE,
           prop.r = FALSE,
           dnn = c('Predicted Turnover', 'Actual Turnover'))
confusionMatrix(as.factor(dt_predict),
                as.factor(turnoverTestLabels))

```

# Stack Model

## Combine Predictions

```{r}
turnover_pred <- data.frame(logPredictionsBinary1, KNNPred, ANNPred, SVMPred, dt_predict, turnoverTestLabels)

summary(turnover_pred)
str(turnover_pred)
```

## Seperate 70:30 test/train

```{r}
set.seed(12453)
test_set <- sample(nrow(turnover_pred), round(nrow(turnover_pred) / 10)*3)

turnover_stack_train <- turnover_pred[-test_set,]
turnover_stack_test <- turnover_pred[test_set, ]

str(turnover_stack_train)
str(turnover_stack_test)
```

## Stacked Decision Tree

```{r, cache = TRUE}
error_cast <- matrix(c(0,1,4,0), nrow=2)

turnover_stack_dt <- C5.0(as.factor(turnoverTestLabels) ~ .,
                          data = turnover_stack_train,
                          costs = error_cast)
```
```{r}
summary(turnover_stack_dt)

turnover_stack_model <- predict(turnover_stack_dt, turnover_stack_test)


CrossTable(turnover_stack_model,
           turnover_stack_test$turnoverTestLabels,
           prop.chisq = FALSE, prop.c = FALSE,
           prop.r = FALSE,
           dnn = c('Predicted Turnover', 'Actual Turnover'))
confusionMatrix(as.factor(turnover_stack_model),
                as.factor(turnover_stack_test$turnoverTestLabels))
```

